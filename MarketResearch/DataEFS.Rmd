---
title: "MarketingResearch"
author: "Valentin Henriot"
date: "22/03/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE, include=FALSE}
library(readxl)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
library(plotly)
library(ggpirate)
library(gplots)
```

```{r warning=FALSE, include=FALSE}
DataEFS <- read_excel("~/L3pgeprojects/MarketResearch/EFSfichier.xlsx", 
    na = "#NULL!")
```

```{r}
delete.na <- function(DataEFS, n=0) {
  DataEFS[rowSums(is.na(DataEFS)) <= n,]
}
```

```{r}
DataEFS1 <- delete.na(DataEFS, 33)
```

```{r}
DataEFS1$MotherBirth <- as.factor(DataEFS1$MotherBirth)
DataEFS1$FatherBirth <- as.factor(DataEFS1$FatherBirth)
DataEFS1$friends <- as.factor(DataEFS1$friends)
DataEFS1$age <- as.numeric(DataEFS1$age)
DataEFS1$sex <- as.factor(DataEFS1$sex)
DataEFS1$Ageofresidence <- as.numeric(DataEFS1$Ageofresidence)
DataEFS1$RespBirth <- as.factor(DataEFS1$RespBirth)
DataEFS1$Bloodneed <- as.factor(DataEFS1$Bloodneed)
DataEFS1$blood <- as.factor(DataEFS1$blood)
DataEFS1$religion <- as.factor(DataEFS1$religion)

DataEFS1$Scenariopsychologicaldistance_DO_closefamil <- as.logical(DataEFS1$Scenariopsychologicaldistance_DO_closefamil)

DataEFS1$Scenariopsychologicaldistance_DO_closestrang <- as.logical(DataEFS1$Scenariopsychologicaldistance_DO_closestrang)

DataEFS1$Scenariopsychologicaldistance_DO_distantFamil <- as.logical(DataEFS1$Scenariopsychologicaldistance_DO_distantFamil)

DataEFS1$Scenariopsychologicaldistance_DO_totalstrang <- as.logical(DataEFS1$Scenariopsychologicaldistance_DO_totalstrang)
```

```{r}
DataEFS1$MotherBirth <- recode(DataEFS1$MotherBirth,"1" = "Métropole", "2" = "OutreMer", "3" = "AutrePays")

DataEFS1$FatherBirth <- recode(DataEFS1$FatherBirth,"1" = "Métropole", "2" = "OutreMer", "3" = "AutrePays")

DataEFS1$RespBirth <- recode(DataEFS1$RespBirth,"1" = "Métropole", "2" = "OutreMer", "3" = "AutrePays")

DataEFS1$friends <- recode(DataEFS1$friends, "1" = "Aucun de mes amis", "2" = "Presque aucun", "3" = "La moitié de mes amis", "4" = "Presque tous", "5" = "Tous mes amis")

DataEFS1$sex <- recode(DataEFS1$sex, "1"= "Femme", "2" = "Homme")

DataEFS1$Bloodneed <- recode(DataEFS1$Bloodneed, "1" = "Oui", "2" = "Non")

DataEFS1$blood <- recode(DataEFS1$blood, "3" = "Groupe_Recherché", "4" = "Commun", "5" = "ContreIndicationMedic", "6" = "NeSaitPas")

DataEFS1$religion <- recode(DataEFS1$religion, "1" = "Désapprouve", "2" = "Désapprouve", "3" = "Désapprouve", "4" = "Ni l'un ni l'autre", "5" = "Ni l'un ni l'autre", "6" = "Ni l'un ni l'autre", "7" = "Approuve")
```

```{r}
DataEFS1$RespMDP <- NULL
DataEFS1$RespMDPLP <- NULL
DataEFS1$motherMDP <- NULL
DataEFS1$motherMDPLP <- NULL
DataEFS1$fatherMDP <- NULL
DataEFS1$fatherMDPLP <- NULL
DataEFS1$Ageofresidence <- NULL
```

```{r}
DataEFS1 <- DataEFS1[c(1, 12, 14, 15, 16, 29, 33, 35, 37, 38, 39, 40, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 13, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 30, 31, 32, 34, 36, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59)] # 1 / 12 / 14 / 16 / 17 / 30 / 34 / 36 à mettre en premier
```

```{r}
summary(DataEFS1)
```

### Réussir à mettre Métrople, OM, autres pays en colonnes

```{r}
DataEFS1 %>%
 filter(!is.na(RespBirth)) %>%
 ggplot() +
 aes(x = RespBirth, fill = RespBirth) +
  xlab("Lieu de naissance des répondants") +
  ylab("Total") +
  ggtitle("Profil des répondants à l'enquête") +
 geom_bar() +
 scale_fill_hue() +
 ggthemes::theme_stata()
```

```{r}
DataEFS1 %>%
 filter(!is.na(sex)) %>%
 ggplot() +
 aes(x = sex, fill = sex) +
  xlab("Sexe") +
  ylab("Total") +
  ggtitle("Profil des répondants à l'enquête") +
 geom_bar() +
 scale_fill_hue() +
 ggthemes::theme_stata()
```

```{r}
EFSrelation <- select(DataEFS1, blood,  RespBirth)

EFSrelation <- group_by(EFSrelation, blood, RespBirth, add = FALSE) %>%
  summarise(count = n())

EFSkhideux <- filter(EFSrelation, blood == "Groupe_Recherché" | blood == "Commun") %>% filter(!is.na(RespBirth))

EFSkhideux <- spread(EFSkhideux, "blood", "count")

EFSkhideux$Groupe_Recherché <- as.numeric(EFSkhideux$Groupe_Recherché)
EFSkhideux$Commun <- as.numeric(EFSkhideux$Commun)
```

```{r}
EFSkhideux_test <- EFSkhideux
EFSkhideux_test <- as.data.frame(EFSkhideux_test)
rownames(EFSkhideux_test) <- EFSkhideux_test[,1]
EFSkhideux_test[,1] <- NULL
EFSkhideux_test <- as.matrix(EFSkhideux_test)
khideuxfinal <- chisq.test(EFSkhideux_test)
```

```{r}
khideuxfinal$observed
```

```{r}
khideuxfinal$expected
```

```{r}
EFSkhideux_plot <- EFSkhideux
EFSkhideux_plot <- as.data.frame(EFSkhideux_plot)
rownames(EFSkhideux_plot) <- EFSkhideux_plot[,1]
EFSkhideux_plot[,1] <- NULL

dt <- as.table(as.matrix(EFSkhideux_plot))

balloonplot(t(dt), main ="Groupe sanguin en fonction du lieu de naissance", xlab ="", ylab="",
            label = FALSE, show.margins = FALSE)
```

```{r}
EFSrelation2 <- spread(EFSrelation, "RespBirth", "count", fill = NA, drop = FALSE)

EFSrelation2$Métropole <- as.numeric(EFSrelation2$Métropole)
EFSrelation2$OutreMer <- as.numeric(EFSrelation2$OutreMer)
EFSrelation2$AutrePays <- as.numeric(EFSrelation2$AutrePays)
EFSrelation2$`<NA>` <- as.numeric(EFSrelation2$`<NA>`)
```

Les individus nés en métropole représentent 71% de l'échantillon des répondants retenus (ceux ayant répondus à au moins 50% des questions), ceux d'OutreMer représentent 6%, ceux étant nés dans un autre pays représentent eux 22% de l'échantillon. Enfin, ceux n'ayant pas indiqué leur lieu de naissance représentent 1% de l'échantillon. Nous les excluerons donc de l'analyse cherchant à mettre en évidence un lien entre le lieu de naissance et le type de sang. De la même manière, nous excluerons ceux qui ne connaissent pas leur groupe sanguin.
Avant d'exclure le groupe de ceux qui ne connaissent pas leur groupe sanguin, il est intéressant de noter les proportions de cette méconnaissance en fonction du lieu de naissance. Ainsi, les personnes nées en métropole sont 23% à ignorer leur groupe sanguin, 26% pour ceux étant nés en Outre-Mer et enfin 28% pour ceux étant nés dans un autre pays.

```{r}
delete.na2 <- function(DataEFS1, n=0) {
  DataEFS1[rowSums(is.na(DataEFS1)) <= n,]
}
```

```{r}
DataEFS2 <- delete.na2(DataEFS1, 3)
```

Pour pouvoir réaliser l'analyse de corrélation, on garde uniquement les individus ayant répondu à l'ensemble des questions (hormis celles qui sont non-chiffrées). L'analyse de corrélation se fait donc sur une population de 956 individus.

```{r}
DataEFS2_norm <- DataEFS2
DataEFS2_norm[,13:59] <- as.data.frame(apply(DataEFS2_norm[,13:59], 2, function(x) (x - min(x))/(max(x)-min(x))))
```

```{r}
library(corrplot)
correlationData = cor(DataEFS2_norm [13:22])
corrplot(correlationData, method = "pie")
```

```{r}
ggplot(DataEFS1) +
  aes(x = age, y = donor) +
  geom_count(colour = "red", alpha = .3) +
  xlab("Âge") +
  ylab("Fréquence de don de sang ou plasma") +
  ggtitle("Qui sont ceux qui donnent le plus en fonction de l'âge ?") +
  labs(size = "effectifs")+
ggthemes::theme_stata()
```

Attention, analyse biaisée car majorité des répondants sont jeunes

```{r}
ggplot(DataEFS1) +
  aes(x = blood, y = donor, colour = blood, fill = blood)  +
  geom_pirate() +
  xlab("Type de sang") +
  ylab("Fréquence de don de sang ou plasma") +
  ggtitle("Qui sont ceux qui donnent le plus en fonction du type de sang ?") +
  ggthemes::theme_stata() +
  theme(panel.grid.minor = element_blank())
```

```{r}
ggplot(DataEFS2) +
  aes(x = RespBirth, y = donor, colour = RespBirth, fill = RespBirth)  +
  geom_pirate() +
  xlab("Lieu de naissance") +
  ylab("Fréquence de don de sang ou plasma") +
  ggtitle("Qui sont ceux qui donnent le plus en fonction du lieu de naissance ?") +
  ggthemes::theme_stata() +
  theme(panel.grid.minor = element_blank())
```


